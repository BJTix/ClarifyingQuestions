<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
	<title>
		Document Questions Study
	</title>
	<head>
	<style>
	body{
		margin: auto;
	}
	button, input[type="button"], input[type="submit"] {
		background-color: #024731;
		border: none;
		color:white;
		border-radius: 8px;
		margin: 4px 2px;
		padding: 6px 8px;
		font-weight:bold;
		border: 2px solid #024731;
	}

	button:hover {
	  border: 2px solid #FFAA22;
	}

	button:disabled,
	button[disabled]{
	  background-color: #cccccc;
		border: 2px solid #cccccc;
	  color: #666666;
	}
	li {
		margin: 4px;
	}
	range, input[type="range"]{
		accent-color: #024731
	}
	
	/*Slider style code from https://www.w3schools.com/howto/howto_js_rangeslider.asp*/
	.slidecontainer {
	  width: 100%;
	  display: grid;
	  grid-template-columns: 30% 40% 30%;
	}
	.sliderbottom {
		grid-column-start: 1;
		grid-column-end: 4;
	}

	.slider {
	  -webkit-appearance: none;
	  width: 100%;
	  height: 15px;
	  border-radius: 5px;
	  background: #d3d3d3;
	  outline: none;
	  opacity: 0.7;
	  -webkit-transition: .2s;
	  transition: opacity .2s;
	}

	.slider:hover {
	  opacity: 1;
	}

	.slider::-webkit-slider-thumb {
	  -webkit-appearance: none;
	  appearance: none;
	  width: 25px;
	  height: 25px;
	  border-radius: 50%;
	  background: #04AA6D;
	  cursor: pointer;
	}

	.slider::-moz-range-thumb {
	  width: 25px;
	  height: 25px;
	  border-radius: 50%;
	  background: #04AA6D;
	  cursor: pointer;
	}

	/*grid container style script from https://www.w3schools.com/css/css_grid.asp */
	
	.grid-container {
	  display: grid;
	  grid-template-columns: auto auto;
	  gap: 10px;
	}

	.grid-container > div {
	  padding: 20px 0;
	  border: 1px solid #ccc;
	  font: 16px Georgia, Garamond, Serif;
	}

	.grid-full {
	  grid-column-start: 1;
	  grid-column-end: 3;
	}
	
	.text-div{	
		overflow:auto;
		-webkit-user-select: all; /* for Safari */
		user-select: all;
		min-height:150px;
		max-height:500px
	}

	textarea{
		font: 16px Georgia, Garamond, Serif;
	}
	
	/*Footer Formatting from: https://www.sitepoint.com/understanding-and-using-rem-units-in-css/*/
	#page-container {
	position: relative;
	min-height: 100vh;
		font: 16px Georgia, Garamond, Serif;
	}

	#bodyDiv {
	padding-bottom: 4rem;    /* Footer height */
	}

	#footer {
	position: absolute;
	bottom: 0;
	width: 100%;
	height: 4rem;            /* Footer height */
	}
	</style>
	</head>
	<Body>
	<div id="page-container">
	<div id="bodyDiv" style="position:relative;left:5%;width:90%;min-height:80%">
		<div style="left:5%; width:90%; vertical-align:middle;position:relative;color:#002315">
			<h1><img src="ConsentLogo.png" style="height:50px;"/>Document Questions Study</h1>
		</div>
		<hr/>
		<div id="ConsentDiv">
			<h2>University of Hawai‘i Online Survey Consent Form</h2>
			Aloha! You are invited to participate in a research study conducted by Bernadette Tix from the Department of Information and Computer Science at the University of Hawai‘i. This research project is a part of a PhD Dissertation studying document creation by Artificial Intelligence programs.
			</br></br>
			<div class="text-div" style="position:relative;left:10%;width:80%;height:50%;border:1px solid #ccc;overflow: auto;" id="ConsentScroll">
				<h3>What am I being asked to do?</h3>
				If you participate in this project, you will be asked to fill out a survey, as well as engage in a back-and-forth conversation with an AI chatbot about creating a document for your personal use, such as a letter, memo, or email. 				
				<h3>Taking part in this study is your choice.</h3>
				Your participation in this project is completely voluntary. You may stop participating at any time. If you stop being in the study, there will be no penalty or loss to you. 
				
				<h3>Why is this study being done?</h3>
				The purpose of this project is to determine whether AI can produce better outputs by asking clarifying questions about what a user needs before creating AI-generated documents. I am seeking adult volunteers to generate documents using an AI, and to give feedback on the output which will allow us to determine whether or not the clarifying questions asked by the AI improved the AI-generated documents.	
				
				<h3>What will happen if I decide to take part in this study?</h3>
				The survey will consist of a brief interaction with an AI chatbot, most likely lasting 10-15 minutes, as well as brief entry and exit surveys. The entry survey will ask for basic demographic information such as your age, gender, and prior experience with AI. When interacting with the AI, you will be asked to think of a document that you would like the AI to write and will answer questions the AI comes up with about your document needs. The exit survey will ask you to rate two different outputs from the AI with questions like, “Would you find this document usable in its current state?” “Is this document close to what you had in mind when you made the request?” and “How would you rate the overall quality of this document?” The survey is anonymous and will be conducted entirely online. The total length of the survey, including interaction with the AI, is expected to last 20-30 minutes.	
				
				<h3>What are the risks and benefits of taking part in this study?</h3>
				I believe there is little risk to you for participating in this research project. You may become stressed or uncomfortable answering any of the survey questions. If you do become stressed or uncomfortable, you can take a break at any time. You can also stop taking the survey or you can withdraw from the project altogether.  
				</br></br>
				There will be no direct benefit to you for participating in this survey. The results of this project may help improve AI’s ability to work in cooperation with humans by giving AI the ability to ask questions and engage in dialog with humans before executing commands.
				
				<h3>Confidentiality and Privacy: </h3>
				You will not be asked for any personal information, such as your name or address. Please do not include any personal information in your survey responses or in your responses to the AI. I will keep all study data secure on a private server. Only my University of Hawai'i advisor and I will have access to the information. Other agencies that have legal permission have the right to review research records. The University of Hawai'i Human Studies Program has the right to review research records for this study.
				
				<h3>Future Research Studies: </h3>
				The data from this study will not be used or distributed for future research studies.  
			</div>
			
			<p>Questions: If you have any questions about this study, please email me at bjavery@hawaii.edu</p>
			<p> You may also contact my advisor, Dr. Kimberly Binsted, at binsted@hawaii.edu</p>
			<p>You may contact the UH Human Studies Program at 808.956.5007 or uhirb@hawaii.edu to discuss problems, concerns and questions, obtain information, or offer input with an informed individual who is unaffiliated with the specific research protocol. Please visit <a href="http://go.hawaii.edu/jRd">http://go.hawaii.edu/jRd</a> for more information on your rights as a research participant.</p>
			
			<p>If you agree to participate in this project, please give electronic consent by checking the box below:</p>
			<p>
				<form action="javascript:btnConsentSubmit()">
					<input type="checkbox" id="chkConsent" name="chkConsent" value="Yes">
					<label for="chkConsent"> <strong>YES</strong> I agree to participate in this study.</label><br>
					<button>Continue</button>
				</form>
			</p>
		</div>
		
		<div id="ConnectingDiv">
		<h2>Please Wait...</h2>
		The experiment is currently being set up. This may take up to two minutes.
		</div>
		
		<div id="ScreenerDiv">
			<h2>Part 1 of 9: Demographics Screener</h2>
			This study is only open to participants who are over the age of 18 and fluent in English. Please answer the questions below to continue.
			<form action="javascript:btnScreenerContinue()">
				<ul>
					<li><label for="Age">Age: </label><input id="Age" name="Age" type="number" min="1" max="100"/></li>
					<li> 
						<label for="English">Are you fluent in English?</label>
						<select name="English" id="English">
							<option value="_"></option>
							<option value="Y">Yes</option>
							<option value="N">No</option>
						</select>
					</li>
				</ul>
				<button>"Continue"</button>
			</form>
		</div>
		<div id="RejectedDiv">
			This study is only open to participants who are over the age of 18 and fluent in English. Thank you for your interest! Please close the browser to exit the survey.
		</div>
		<div id="DemographicsDiv">
			<h2>Part 2 of 9: Demographics</h2>
			<h3>Welcome!</h3>
			Thank you for taking the time to participate in this study. In this study, you will be using AI to create a short document of your choosing. Completion of the study may take as little as a few minutes or as much as half an hour, depending on the complexity of the document you are trying to create. Please <strong>DO NOT</strong> press the back button on your broswer or refresh the page, as this will reset the survey and you will not be able to recover your work in progress. When you are ready to begin, please answer the following demographic questions about yourself and then click the "continue" button below.
			<form action="javascript:btnDemographicsContinue()">
				<ul>
					<li> 
						<label for="Gender">Gender:</label>
						<select name="Gender" id="Gender">
							<option value="Blank"></option>
							<option value="Female">Female</option>
							<option value="Male">Male</option>
							<option value="Other">Other / Nonbinary</option>
						</select>
					</li>
					<li> 
						<label for="Experience">What is your prior experience with generative AI such as ChatGPT, Bard, or similar programs?</label></br>
						<select name="Experience" id="Experience">
							<option value="0"></option>
							<option value="3">I use generative AI regularly.</option>
							<option value="2">I have used generative AI before, but not often.</option>
							<option value="1">I have never used generative AI before.</option>
						</select>
					</li>
				<button>Continue</button>
			</form>
		</div>
		<div id="PromptDiv">
			<h2>Part 3 of 9: Describe your Document</h2>
			On this page, you will be communicating with an AI that is capable of writing short documents such as letters, memos, emails, and short reports. Please think of a document you would like the AI to create for you. This could be a document you actually need, or one that you have just made up for the experiment. Either way, please think in detail about what you would need this document to include. When you are ready, write out what you need in the textbox below. After you submit your prompt, the AI will ask you a series of questions, and you will then be given two versions of the document you requested, and asked for feedback on which version you prefer.
			<br/><br/>
			Example prompts: 
			<br/><em><ul>
			<li>“Please write a cover letter for a job working in tech support for a college student with one year of prior tech support experience.” </li>
			
			<li>“Write an email to my boss asking them if they can meet next week to discuss a project which is behind schedule.”</li>
			
			<li>“I want to reach out to a friend I haven’t spoken to in a while. Give me an outline for a letter to help me figure out what I should say.”</li>
			</ul></em>
			<h3>Enter your prompt below:</h3>
			<textarea id="prompt" name="txt_prompt" rows="5" style="width:80%"></textarea>
			<br/>
			<button onclick="btnPrompt()" id="btn_Prompt">Continue</button>
			
		</div>
		<div id="PleaseWaitDiv">
			<h2>Please Wait ... </h2>
			The AI is working on your request. This may take several minutes.
		</div>
		<div id="QADiv">
			<h2>Part 4 of 9: Questions and Answers</h2>
			To give you the best results, the AI would like to ask you a few questions about the document you need. Please provide your answers and then click "continue."
			<h3>Questions:</h3>
			<label for="txtA1" id="lblQ1"></label><br/>
			<textarea id="txtA1" name="txtA1" rows="3" style="width:80%;left:5%"></textarea><br/><br/>
			<label for="txtA2" id="lblQ2"></label><br/>
			<textarea id="txtA2" name="txtA2" rows="3" style="width:80%;left:5%"></textarea><br/><br/>
			<label for="txtA3" id="lblQ3"></label><br/>
			<textarea id="txtA3" name="txtA3" rows="3" style="width:80%;left:5%"></textarea><br/><br/>
			<div>
			<p>Would you like to provide any thoughts or feedback about these questions?</p>
			<textarea id="txtFeedbackOnQuestions" name="txtFeedbackOnQuestions" rows="5" style="width:80%"></textarea><br/>
			</div>
			<button onclick="btnQA()" id="btnQA">Continue</button>
		</div>
		<div id="FirstResultDiv">
			<h2>Part 5 of 9: Rating the Douments</h2>
			Thank you for your thoughtful answers! The AI has considered your prompt and your responses to its questions, and has generated two different possible documents for you. Please read each one and answer the questions that follow. <br/><br/>
			<div class="grid-container">
				<div class="text-div" id="FirstResultText"></div>
				<div class="text-div" id="SecondResultText"></div>
				<div class="grid-full">
					<center><strong>
						Which document do you prefer overall? <br/>
						<p>
							<div class="slidecontainer">
								<div>Strongly Prefer Document 1</div>
								<div><input id="prefSlider" type="range" min="-10" max="10" value="0" class="slider" id="myRange"></div>
								<div>Strongly Prefer Document 2</div>
								<div class="sliderbottom">^</div>
								<div class="sliderbottom">No Preference</div>
							</div>
						</p>
						<p>
							Which document would be more useful to you in its current state? <br/>
							<div class="slidecontainer">
								<div>Document 1 is More Useful</div>
								<div><input id="useSlider" type="range" min="-10" max="10" value="0" class="slider" id="myRange"></div>
								<div>Document 2 is More Useful</div>
								<div class="sliderbottom">^</div>
								<div class="sliderbottom">Both are Equally Useful</div>
							</div>
						</p>
					</strong></center>
				</div>
				<div>
				Do you have any feedback about document 1?
				<textarea id="txtDoc1Feedback1" name="txtDoc1Feedback1" rows="5" style="width:95%"></textarea><br/>
				</div>
				<div>
				Do you have any feedback about document 2?
				<textarea id="txtDoc2Feedback1" name="txtDoc2Feedback2" rows="5" style="width:95%"></textarea><br/>
				</div>
			</div>
			<button onclick="recordInitialRatings()" id="btnRatings1">Continue</button>
		</div>
		<div id="RefiningDiv">
			<h2>Part 6 of 9: Refining the Douments</h2>
			Documents generated by AI can sometimes be improved by giving the AI further instructions after it has completed its initial attempt. If you would like to refine one or both of these documents, enter further instructions below. Please try to get each document as close as you can to a document you would actually want to use. <br/><br/>
			<div class="grid-container">
				<div class="text-div" id="RefiningDoc1"></div>
				<div class="text-div" id="RefiningDoc2"></div>
				<div>
				Enter additional instructions for document 1 below:
				<textarea id="txtDoc1Refine" name="txtDoc1Refine" rows="5" style="width:95%"></textarea><br/>
				<button onclick="refineDoc1()" id="btnRefineDoc1">Refine Document 1 (3 remaining)</button>
				</div>
				<div>
				Enter additional instructions for document 2 below:
				<textarea id="txtDoc2Refine" name="txtDoc2Refine" rows="5" style="width:95%"></textarea><br/>
				<button onclick="refineDoc2()" id="btnRefineDoc2">Refine Document 2 (3 remaining)</button>
				</div>
			</div>
			<button onclick="doneRefining()" id="btnDoneRefining">Continue to Next Step</button>
		</div>
		<div id="FinalResultDiv">
			<h2>Part 7 of 9: Rating the Douments</h2>
			<p>Thank you for taking the time to refine the documents. Please rate the two documents again, based on how they’ve turned out now after the refining process.</p>
			<div class="grid-container">
				<div class="text-div" id="FirstResultText2"></div>
				<div class="text-div" id="SecondResultText2"></div>				
				<div class="grid-full">
					<center><strong>
						Which document do you prefer overall? <br/>
						<p>
							<div class="slidecontainer">
								<div>Strongly Prefer Document 1</div>
								<div><input id="prefSlider2" type="range" min="-10" max="10" value="0" class="slider" id="myRange"></div>
								<div>Strongly Prefer Document 2</div>
								<div class="sliderbottom">^</div>
								<div class="sliderbottom">No Preference</div>
							</div>
						</p>
						<p>
							Which document would be more useful to you in its current state? <br/>
							<div class="slidecontainer">
								<div>Document 1 is More Useful</div>
								<div><input id="useSlider2" type="range" min="-10" max="10" value="0" class="slider" id="myRange"></div>
								<div>Document 2 is More Useful</div>
								<div class="sliderbottom">^</div>
								<div class="sliderbottom">Both are Equally Useful</div>
							</div>
						</p>
					</strong></center>
				</div>
			<div>
			Do you have any feedback about document 1?
			<textarea id="txtDoc1Feedback2" name="txtDoc1Feedback1" rows="5" style="width:95%"></textarea><br/>
			</div>
			<div>
			Do you have any feedback about document 2?
			<textarea id="txtDoc2Feedback2" name="txtDoc2Feedback2" rows="5" style="width:95%"></textarea><br/>
			</div>
			</div>
			<button onclick="recordFinalRatings()" id="btnRatings2">Continue</button>
		</div>
		<div id="ResultsAndContinuationDiv">
			<h2>Part 8 of 9: Results and Continuation</h2>
			<p>Thank you for completing the study! The documents you have created are provided below for your use. If you would like to keep a copy of the documents you created, you can copy them below. Once you exit the browser or navigate away from this page, you will no longer be able to access these documents.
			</p>
			<div class="grid-container">
				<div>
					<h3>Document #1</h3>
					<div id="FirstResultTextExit" class="text-div"></div>
					<br/>
					<button onclick="copyDoc1()" id="btnExitFinish">Copy to Clipbord</button>
				</div>
				<div>
					<h3>Document #2</h3>
					<div id="SecondResultTextExit" class="text-div"></div>
					<br/>
					<button onclick="copyDoc2()" id="btnExitFinish">Copy to Clipbord</button>
				</div>
			</div>
			<p>Would you like to create another document, or proceed to the exit survey and exit the study?</p>
			<button id="btnGoAgain" onClick="goAgain()">Create Another Document</button>
			<button id="btnExit" onClick="nextStep()">Proceed to Exit Survey</button>
		</div>
		<div id="ExitSurveyDiv">
			<h2>Part 9 of 9: Exit Survey</h2>
			Thank you for rating the AI’s responses. For the final step in this study, please rate the following statements on a scale of “Strongly Agree” to “Strongly Disagree”.
			<hr/>
			It was annoying to have to answer questions even though I had already explained what I wanted the AI to do.
			<br/>Strongly Disagree <input type="range" id="EQ1" min="0" max="10" /> Strongly Agree
			<hr/>
			I felt like the AI was more engaged with my problem because it asked follow-up questions.
			<br/>Strongly Disagree <input type="range" id="EQ2" min="0" max="10" /> Strongly Agree
			<hr/>
			I would be willing to answer follow-up questions from an AI if answering questions led to better results.
			<br/>Strongly Disagree <input type="range" id="EQ3" min="0" max="10" /> Strongly Agree
			<hr/>
			I liked that the AI showed me two options to pick between, instead of only picking the option it thought was best.
			<br/>Strongly Disagree <input type="range" id="EQ4" min="0" max="10" /> Strongly Agree
			<hr/>
			Answering the questions asked by the AI made me think about my request in ways I hadn’t previously considered. 
			<br/>Strongly Disagree <input type="range" id="EQ5" min="0" max="10" /> Strongly Agree
			<hr/><br/>
			Do you have any additional feedback or comments (optional)?
			<textarea id="txtFeedback" name="txtFeedback" rows="5" style="width:80%"></textarea><br/>
			<button onclick="recordExitSurvey()" id="btnExitFinish">Finish!</button>
		</div>
		<div id="GoodbyeDiv">
			<h2>Thank You!</h2>
			<p>You have completed the experiment! Thank you for your participation. If you have any further questions, please contact Bernadette Tix at bjavery@hawaii.edu. Please close your browser to exit. 
			</p><p>
			If you would like to keep a copy of the documents you created, you can copy them below. Once you exit the browser or navigate away from this page, you will no longer be able to access these documents.
			</p>
			<div class="grid-container">
				<div>
					<h3>Document #1</h3>
					<div id="ThankYouDoc1" class="text-div"></div>
					<br/>
					<button onclick="copyDoc1()" id="btnExitFinish">Copy to Clipbord</button>
				</div><div>
					<h3>Document #2</h3>
					<div id="ThankYouDoc2" class="text-div"></div>
					<br/>
					<button onclick="copyDoc2()" id="btnExitFinish">Copy to Clipbord</button>
				</div>
			</div>
			<hr/>
			<p>
			For SurveyCircle users (www.surveycircle.com): The Survey Code is: Y9K3-7F11-RXY1-3HFX
			<br/>Redeem Survey Code with one click: <a href="https://www.surveycircle.com/Y9K3-7F11-RXY1-3HFX/">https://www.surveycircle.com/Y9K3-7F11-RXY1-3HFX/</a>
			</p>
		</div>
		<div id="ErrorDiv">
			<h2>Processing Error!</h2>
			An error has occurred! This can happen if the AI receives unexpected input it doesn't know how to handle. Click the button below to try to recover.<br/>
			<div id="errormsg"></div>
			<button id="btnError" onclick="errorRecovery()">Recover</button>
		</div>		
	</div>
	<footer id="footer" style="background-color:#024731;color:#EEEEEE;">
		<div id="FooterText" style="position:relative;left:5%;width:90%;height: 3rem;top: 5px;">
			Dr. Kimberly Binsted, Principal Investigator</br>
			<em>Project Title:</em> Better Results Through Ambiguity Resolution: Large Language Models that Ask Clarifying Questions
		</div>
	</footer>
	</div>
	</body>
</html>
<script>
//Define variables used for prompt, QA, and responses
var questions = "";
var firstPrompt = "";
var userAnswers = "";
var finalQADoc = "";
var baselineDoc = "";
var sessionid = 0;
var Q1 = "";
var Q2 = "";
var Q3 = "";
var A1 = "";
var A2 = "";
var A3 = "";
var endIndex = -1;
//Get the session ID:
getSessionID();

//define variables and functions for progressing through the wizard
var step = 0;
var ConsentDiv = document.getElementById("ConsentDiv");
var DemographicsDiv = document.getElementById("DemographicsDiv");
var PromptDiv = document.getElementById("PromptDiv");
var PleaseWaitDiv = document.getElementById("PleaseWaitDiv");
var QADiv = document.getElementById("QADiv");
var FirstResultDiv = document.getElementById("FirstResultDiv");
var SecondResultDiv = document.getElementById("SecondResultDiv");
var FirstResultText = document.getElementById("FirstResultText");
var SecondResultText = document.getElementById("SecondResultText");
var FirstResultTextExit = document.getElementById("FirstResultTextExit");
var SecondResultTextExit = document.getElementById("SecondResultTextExit");
var ExitSurveyDiv = document.getElementById("ExitSurveyDiv");
var GoodbyeDiv = document.getElementById("GoodbyeDiv");
var ErrorDiv = document.getElementById("ErrorDiv");
var ConnectingDiv = document.getElementById("ConnectingDiv");
var ScreenerDiv = document.getElementById("ScreenerDiv");
var RejectedDiv = document.getElementById("RejectedDiv");
var RefiningDiv = document.getElementById("RefiningDiv");
var FinalResultDiv = document.getElementById("FinalResultDiv");
var ResultsAndContinuationDiv = document.getElementById("ResultsAndContinuationDiv");

var refinementsRemainingDoc1 = 3;
var refinementsRemainingDoc2 = 3;

//Determine which output will be shown first by a coin flip.
var showQAFirst = false;
if(Math.random() < 0.5) showQAFirst = true;
//console.log("Show QA First: " + (showQAFirst ? "yes" : "no"));

//Determine which LLM to use
var LLM = "";
var rand = Math.random();
//rand = 0;
if(rand < 0.333) LLM = "Gemini";
else if(rand < 0.666) LLM = "GPT3.5";
else LLM = "GPT4"

//console.log("LLM: " + LLM);
window.scrollTo(0,0);

/*Hide all the divs / steps.*/
function hideAll(){
	ConsentDiv.hidden = true;
	DemographicsDiv.hidden = true;
	PromptDiv.hidden = true;
	PleaseWaitDiv.hidden = true;
	QADiv.hidden = true;
	FirstResultDiv.hidden = true;
	RefiningDiv.hidden= true;
	ExitSurveyDiv.hidden = true;
	GoodbyeDiv.hidden = true;
	ErrorDiv.hidden = true;
	ConnectingDiv.hidden = true;
	ScreenerDiv.hidden = true;
	RejectedDiv.hidden = true;
	FinalResultDiv.hidden = true;
	ResultsAndContinuationDiv.hidden = true;
}

/*
This function is used to progress through the wizard.
*/
function nextStep(){
	step++;
	//Check for a good connection:
	if(2 == step && 0 < sessionid) step++;
	//if the user entered no refinements we can skip the re-rating section.
	if(12 == step && 3 == refinementsRemainingDoc1 && 3 == refinementsRemainingDoc1) step++;
	//reveal just one div based on the step. Hide the rest.
	hideAll();
	//console.log("Proceeding to step " + step);
	switch(step){
		case 1: ConsentDiv.hidden = false; break;
		case 2: ConnectingDiv.hidden = false; break;
		case 3: ScreenerDiv.hidden = false; break;
		case 4: RejectedDiv.hidden = false; break;
		case 5: DemographicsDiv.hidden = false; break;
		case 6: PromptDiv.hidden = false; break;
		case 7: PleaseWaitDiv.hidden = false; break; //the please wait screen is shown twice.
		case 8: QADiv.hidden = false; break;
		case 9: PleaseWaitDiv.hidden = false; break; //the please wait screen is shown twice.
		case 10: FirstResultDiv.hidden = false; break;
		case 11: RefiningDiv.hidden = false; break;
		case 12: FinalResultDiv.hidden = false; break;
		case 13: ResultsAndContinuationDiv.hidden = false; break;
		case 14: ExitSurveyDiv.hidden = false; break;
		default: GoodbyeDiv.hidden = false; break;
	}		
	//Scroll to the top:
	window.scrollTo(0,0);
}
//Call the nextStep function once to initialize:
nextStep();
/*
This function is called when the "Submit" button is pressed on the consent.
*/
function btnConsentSubmit(){
	var scrollDiv = document.getElementById("ConsentScroll");
	//Check if they have clicked "I Agree"
	var checked = document.getElementById("chkConsent").checked;
	if(!checked){ 
		alert('You must agree to participate in this study before proceeding. Please check "YES I agree" before continue.');
		return;
	}
	//check if the user read the whole agreement:
	else if(scrollDiv.scrollTop == 0){
		alert("Please read the entire consent before continuing.");
		return;
	}
	//Done with validation, proceed to next step:
	else{
		//Move on to the next step.
		nextStep();
	}	
}
async function btnScreenerContinue(){
	var Age = document.getElementById("Age").value;
	if (null == Age || "" == Age) Age = 0;
	var English = document.getElementById("English").value;
	//Warning message:
	if(English == "_" || Age == 0) alert("Please answer both questions in order to continue!");
	else if(English == "Y" && 18 <= Age) {
		//Advance two steps to skip over the screener rejection screen.
		nextStep();
		nextStep();
	}
	else {
		//Advance just one step to get to the screener rejection screen.
		nextStep();
	}
}
/*
This function is called when the "Continue" button is pressed on the Demographics questions.
*/
async function btnDemographicsContinue(){
	//Save answers to DB. 
	var Age = document.getElementById("Age").value;
	if (null == Age || "" == Age) Age = 0;
	var English = document.getElementById("English").value;
	var Gender = document.getElementById("Gender").value;
	var Experience = document.getElementById("Experience").value;
	//Put it all together into the DB call:
	//TODO: Need a new place to save these results.
	var params = { "SessionID": sessionid, "Age": Age, "Gender":Gender, "Experience":Experience,"English":English};
	await AzureFunction("RecordDemographics",params);
	
	//No validation needed for this one. Blanks are OK.
	nextStep();
}
/*
This function is called when the "Continue" button is pressed on the Prompt screen.
*/
async function btnPrompt(){
	try
	{	
		var txtPrompt = document.getElementById("prompt");
		if(txtPrompt.value == null || txtPrompt.value.length < 10){
			alert("Please enter a prompt describing the document you would like the AI to write for you.");
		}
		else{
			firstPrompt = txtPrompt.value;
			//Here we're going to go forward two steps. Once for the "please wait" screen and once for the question screen.
			//This one takes us to a "please wait" screen.
			nextStep();
			fullPrompt = "A user is requesting the creation of a new document. This is their request:\nuser:\"" + firstPrompt + "\"\nIdentify any areas of significant ambiguity in the prompt, areas that could benefit from more thought or attention from the user, or helpful tips the user may not have considered. Write these out in a short list."
			var ambiguity = await AIConversation(fullPrompt, false);
			fullPrompt = "Pick the three most important items from the list you just generated, and write a list of three insightful questions that will improve the requested document. Phrase the questions as direct questions to the user. Format your response as a numbered list of exactly 3 questions."
			questions = await AIConversation(fullPrompt, false);
			//Now we need to split the questions up into multiple questions:
			endIndex = questions.indexOf("\n", questions.indexOf("\n3") + 1);
			if (endIndex == -1) endIndex = questions.length;
			Q1 = questions.substring(questions.indexOf("\n1") + 1, questions.indexOf("\n2", questions.indexOf("\n1")));
			Q2 = questions.substring(questions.indexOf("\n2") + 1, questions.indexOf("\n3", questions.indexOf("\n2")));
			Q3 = questions.substring(questions.indexOf("\n3") + 1, endIndex);
			//Now that the processing is done, we're ready for the Q/A screen:
			nextStep();
			//Set up the question prompts:
			document.getElementById("lblQ1").innerHTML = Q1;
			document.getElementById("lblQ2").innerHTML = Q2;
			document.getElementById("lblQ3").innerHTML = Q3;
		}
	}
	catch(err){
		processingError(err);
	}
}
/*
This function is called when the "Continue" button is pressed on the Q/A screen.
*/
async function btnQA(){
	try{
		//Get the answers off the page:
		A1 = document.getElementById("txtA1").value;
		A2 = document.getElementById("txtA2").value;
		A3 = document.getElementById("txtA3").value;
		Feedback = document.getElementById("txtFeedbackOnQuestions").value;
		//Perform validation:
		if(A1 == null || A1.length == 0 || 
			A2 == null || A2.length == 0 ||
			A3 == null || A3.length == 0){
			alert("Please answer all questions before continuing!");
			return; //End here if validation fails.
		}
		if (Feedback == null) Feedback = "";
		//Continue on if validation was successful:
		//Move on to another "Please Wait" screen while processing.
		nextStep();
		//Save QA to the DB:		
		var params = { "SessionID": sessionid, "Prompt": firstPrompt, "Q1":Q1,"A1":A1,"Q2":Q2,"A2":A2,"Q3":Q3,"A3":A3,"LLM":LLM,"Feedback":Feedback};
		await AzureFunction("RecordPromptAndQA",params);
		//Submit these answers to the AI:
		QAPrompt = "Generate a high quality document that meets the users needs, considering both their initial prompt and the answers they gave when asked for details. Include creative original insights that will improve the quality of the document but do not deviate too far from the user's original intent.";
		//We need both the final QA doc as well as a baseline to compare to:
		finalQADoc = await AIConversation(QAPrompt, true);
		baselineDoc = await AIConversation(firstPrompt, false);
		var finalQADocHTML = finalQADoc.replace(/(?:\r\n|\r|\n)/g,"</br>");
		var baselineDocHTML = baselineDoc.replace(/(?:\r\n|\r|\n)/g,"</br>");
		if(showQAFirst) {
			FirstResultText.innerHTML = finalQADocHTML;
			SecondResultText.innerHTML = baselineDocHTML;
			
			FirstResultTextExit.innerHTML = finalQADocHTML;
			SecondResultTextExit.innerHTML = baselineDocHTML;
			
			document.getElementById("RefiningDoc1").innerHTML = finalQADocHTML;
			document.getElementById("RefiningDoc2").innerHTML = baselineDocHTML;
		}
		else {
			FirstResultText.innerHTML = baselineDocHTML;
			SecondResultText.innerHTML = finalQADocHTML;
			
			FirstResultTextExit.innerHTML = baselineDocHTML;
			SecondResultTextExit.innerHTML = finalQADocHTML;
			
			document.getElementById("RefiningDoc1").innerHTML = baselineDocHTML;
			document.getElementById("RefiningDoc2").innerHTML = finalQADocHTML;
		}
		//Save answers to the DB:		
		var params = { "SessionID": sessionid, "DocBaseline":baselineDoc,"DocQA":finalQADoc,"ShowQAFirst": (showQAFirst ? "1" : "0")};
		await AzureFunction("RecordInitialDocs",params);
		
		//Once processing is complete, move on to the next screen:
		nextStep();
	}
	catch(err){
		processingError(err);
	}
}
/*
Record results from the first document:
*/
async function recordInitialRatings(){
	//console.log("Recording initial ratings ...")
	btnRatings1.disabled = true;
	//save to DB:
	Preference = document.getElementById("prefSlider").value;
	Usefulness = document.getElementById("useSlider").value;
	FeedbackDoc1 = document.getElementById("txtDoc1Feedback1").value;
	FeedbackDoc2 = document.getElementById("txtDoc2Feedback1").value;
		
	if(showQAFirst){
		//if QA is shown first, invert the scores. That way positive scores always indicate preference for QA doc.
		Preference = -Preference;
		Usefulness = -Usefulness;
		var params = { "SessionID": sessionid, "Preference": Preference.toString(), "Usefulness":Usefulness.toString(),"BaselineFeedback":FeedbackDoc2,"QAFeedback":FeedbackDoc1}
		await AzureFunction("RecordInitialRatings",params);
	}
	else {
		var params = { "SessionID": sessionid, "Preference": Preference, "Usefulness":Usefulness,"BaselineFeedback":FeedbackDoc1,"QAFeedback":FeedbackDoc2}
		await AzureFunction("RecordInitialRatings",params);
	}
	//go to the next step:
	nextStep();
	//console.log("Recorded!")
}
/*
Refine the first document using additional user feedback:
*/
async function refineDoc1(){
	//Check how many attempts are left:
	if(refinementsRemainingDoc1 < 1) {
		alert("You cannot enter any further instructions.");
		return;
	}
	
	//get references to the controls we'll be using:
	Doc1 = document.getElementById("RefiningDoc1");
	txtFeedback1 = document.getElementById("txtDoc1Refine");
	myButton1 = document.getElementById("btnRefineDoc1");
	doneButton = document.getElementById("btnDoneRefining");
	
	//input washing on the feedback:
	strFeedback = txtFeedback1.value;
	if(strFeedback.length < 5) {
		alert("Please enter your instructions in the area provided.");
		return;
	}
	
	//Disable the button to prevent it being used while the processis happening:
	myButton1.disabled = true;
	doneButton.disabled = true;
	disableNextButton = true;
	
	//Display a message on the button and the text window:
	myButton1.innerHTML = "Please wait ...";
	txtFeedback1.value = "";
	Doc1.innerHTML = "Please wait. The AI is generating a new document based on your feedback. This may take several minutes.";
	
	//submit the request to OpenAI
	//console.log((showQAFirst ? "yes" : "no"));
	finalQADoc = await AIConversation(strFeedback, showQAFirst);
	
	//update the counter:
	refinementsRemainingDoc1 = refinementsRemainingDoc1 - 1;
	
	//Update the text for the document and the button.
	Doc1.innerHTML = finalQADoc.replace(/(?:\r\n|\r|\n)/g,"</br>");
	myButton1.innerHTML = "Refine Document 1 (" + refinementsRemainingDoc1 + " remaining)"
	myButton1.disabled = false;
	doneButton.disabled = false;
	
	//Save the results.
	var params = { "SessionID": sessionid, "Instructions": strFeedback, "newDoc":finalQADoc,"UseQuestions":(showQAFirst ? "yes" : "no")}
	await AzureFunction("RecordRefinement",params);	
}
/*
Refine the second document using additional user feedback:
*/
async function refineDoc2(){
	//Check how many attempts are left:
	if(refinementsRemainingDoc2 < 1) {
		alert("You cannot enter any further instructions.");
		return;
	}
	
	//get references to the controls we'll be using:
	Doc2 = document.getElementById("RefiningDoc2");
	txtFeedback2 = document.getElementById("txtDoc2Refine");
	myButton2 = document.getElementById("btnRefineDoc2");
	doneButton = document.getElementById("btnDoneRefining");
	
	//input washing on the feedback:
	strFeedback2 = txtFeedback2.value;
	if(strFeedback2.length < 5) {
		alert("Please enter your instructions in the area provided.");
		return;
	}
	
	//Disable the button to prevent it being used while the processis happening:
	myButton2.disabled = true;
	doneButton.disabled = true;
	
	//Display a message on the button and the text window:
	myButton2.innerHTML = "Please wait ...";
	txtFeedback2.value = "";
	Doc2.innerHTML = "Please wait. The AI is generating a new document based on your feedback. This may take several minutes.";
	
	//submit the request to OpenAI
	//console.log((showQAFirst ? "yes" : "no"));
	baselineDoc = await AIConversation(strFeedback2, !showQAFirst);
	
	//update the counter:
	refinementsRemainingDoc2 = refinementsRemainingDoc2 - 1;
	
	//Update the text for the document and the button.
	Doc2.innerHTML = baselineDoc.replace(/(?:\r\n|\r|\n)/g,"</br>");
	myButton2.innerHTML = "Refine Document 2 (" + refinementsRemainingDoc2 + " remaining)"
	myButton2.disabled = false;
	doneButton.disabled = false;
	
	//Save the results.
	var params = { "SessionID": sessionid, "Instructions": strFeedback2, "newDoc":baselineDoc,"UseQuestions":(showQAFirst ? "no" : "yes")}
	await AzureFunction("RecordRefinement",params);	
}
/*
This function is called when the user is done refining the results and ready to proceed to step 8:
*/
async function doneRefining(){
	//Place the final docs in the right controls:
	Doc1 = document.getElementById("RefiningDoc1").innerHTML;
	Doc2 = document.getElementById("RefiningDoc2").innerHTML;
	
	document.getElementById("FirstResultText2").innerHTML = Doc1;
	document.getElementById("SecondResultText2").innerHTML = Doc2;
	
	document.getElementById("ThankYouDoc1").innerHTML = Doc1;
	document.getElementById("ThankYouDoc2").innerHTML = Doc2;
			
	FirstResultTextExit.innerHTML = Doc1;
	SecondResultTextExit.innerHTML = Doc2;
	
	//move to the next step:	
	nextStep();
}
/*
Record results from the documents after the user has finished giving refining prompts:
*/
async function recordFinalRatings(){
	//console.log("Recording final ratings ...")
	btnRatings1.disabled = true;
	//save to DB:
	Preference = document.getElementById("prefSlider2").value;
	Usefulness = document.getElementById("useSlider2").value;
	FeedbackDoc1 = document.getElementById("txtDoc1Feedback2").value;
	FeedbackDoc2 = document.getElementById("txtDoc2Feedback2").value;
		
	if(showQAFirst){
		//if QA is shown first, invert the scores. That way positive scores always indicate preference for QA doc.
		Preference = -Preference;
		Usefulness = -Usefulness;
		var params = { "SessionID": sessionid, "Preference": Preference.toString(), "Usefulness":Usefulness.toString(),"BaselineFeedback":FeedbackDoc2,"QAFeedback":FeedbackDoc1}
		await AzureFunction("RecordFinalRatings",params);
	}
	else {
		var params = { "SessionID": sessionid, "Preference": Preference, "Usefulness":Usefulness,"BaselineFeedback":FeedbackDoc1,"QAFeedback":FeedbackDoc2}
		await AzureFunction("RecordFinalRatings",params);
	}
	//go to the next step:
	nextStep();
	//console.log("Recorded!");
}
/*
This function is used for people who want to go again and redo the study.
*/
async function goAgain(){
	//Get a new ID and record the repeat:
	//console.log("Starting a new session...");
	var params = {"SessionID": sessionid};
	sessionid = await AzureFunction("RepeatSession",params);
	//console.log("New Session ID: " + sessionid);
	
	//Reset Variables:	
	Doc1 = "";
	Doc2 = "";
	refinementsRemainingDoc1 = 3;
	refinementsRemainingDoc2 = 3;
	questions = "";
	firstPrompt = "";
	userAnswers = "";
	finalQADoc = "";
	baselineDoc = "";
	Q1 = "";
	Q2 = "";
	Q3 = "";
	A1 = "";
	A2 = "";
	A3 = "";
	endIndex = -1;
	
	//Reset Controls
	document.getElementById("FirstResultText2").innerHTML = "";
	document.getElementById("SecondResultText2").innerHTML = "";
	FirstResultTextExit.innerHTML = "";
	SecondResultTextExit.innerHTML = "";
	document.getElementById("prefSlider").value = 0;
	document.getElementById("useSlider").value = 0;
	document.getElementById("prefSlider2").value = 0;
	document.getElementById("useSlider2").value = 0;
	document.getElementById("txtDoc1Feedback1").value = "";
	document.getElementById("txtDoc1Feedback2").value = "";
	document.getElementById("txtDoc2Feedback1").value = "";
	document.getElementById("txtDoc2Feedback2").value = "";
	document.getElementById("txtFeedbackOnQuestions").value = "";
	document.getElementById("txtA1").value = "";
	document.getElementById("txtA2").value = "";
	document.getElementById("txtA3").value = "";
	document.getElementById("prompt").value = "";
	document.getElementById("txtDoc2Refine").value = "";
	document.getElementById("txtDoc1Refine").value = "";
	btnRatings1.disabled = false;
		
	//Redo LLM and QAFirst variables:
	//Determine which output will be shown first by a coin flip.
	showQAFirst = false;
	if(Math.random() < 0.5) showQAFirst = true;
	//console.log("Show QA First: " + (showQAFirst ? "yes" : "no"));

	//Determine which LLM to use
	var rand = Math.random();
	//rand = 0;
	if(rand < 0.333) LLM = "Gemini";
	else if(rand < 0.666) LLM = "GPT3.5";
	else LLM = "GPT4"
	//console.log(LLM);

	//Reset the Step
	step = 5;
	nextStep();
}
/*
Record results from the exit survey:
*/
async function recordExitSurvey(){
	//console.log("Recording exit survey...")
	//save to DB:
	EQ1 = document.getElementById("EQ1").value;
	EQ2 = document.getElementById("EQ2").value;
	EQ3 = document.getElementById("EQ3").value;
	EQ4 = document.getElementById("EQ4").value;
	EQ5 = document.getElementById("EQ5").value;
	Feedback = document.getElementById("txtFeedback").value;
	params = { "SessionID": sessionid,"ExitAnnoying": EQ1,"ExitEngaged":EQ2,"ExitWilling":EQ3,"ExitTwoOptions":EQ4,"ExitMadeMeThink":EQ5,"ExitFeedback":Feedback }
	await AzureFunction("RecordExitSurvey",params);
	//go to the next step:
	nextStep();
	//console.log("Recorded!")
}
/*
This function shows the processing error page. 
*/
function processingError(err){
	hideAll();
	ErrorDiv.hidden = false;
	//document.getElementById("errormsg").innerHTML = err.message
	console.log("Error! " + err.message);
}
/*
This function coppies the first document to the clippboard. 
*/
function copyDoc1(){
	if(showQAFirst) navigator.clipboard.writeText(finalQADoc);
	else navigator.clipboard.writeText(baselineDoc);
	alert("Document #1 has been coppied to your clipboard. You are free to keep or use this document as you wish.");
}

/*
This function coppies the second document to the clippboard. 
*/
function copyDoc2(){
	if(showQAFirst) navigator.clipboard.writeText(baselineDoc);
	else navigator.clipboard.writeText(finalQADoc);
	alert("Document #2 has been coppied to your clipboard. You are free to keep or use this document as you wish.");
}

/*
An error recovery function: attempt to reload the most recent step.
*/
function errorRecovery(){
	//console.log("Attempting recovery from step " + step);
	step --;
	nextStep();
}

//Make a call to the Azure Function that I have set up ahead of time.
async function getSessionID(){
	//Sometimes it takes a few tries to get a session ID, so we're going to try a few times:
	var MaxAttempts = 12;
	var result = await getSessionID_inner(MaxAttempts);
	if (result.substring(0,5) == "Error"){
		console.log("Failed to get session ID after " + MaxAttempts + " attempts. Server response: " + result);
		return -1;
	}
	else{
		//console.log("Successfully obtained Session ID: " + result);
		//If we are on the "waiting for connection" step, then advance once a good connection is established.
		if(2 == step) nextStep();
		sessionid = result;
		//Save consent timestamp.
		NewRecord();
		return result;
	}
}
async function getSessionID_inner(retries){
	//Sometimes it takes a few tries to get a session ID, so we're going to retry if needed:
	//console.log("Attempting to get a session ID... " + retries + " retries remaining.");
	var sessionid = await AzureFunction("GetNewSessionID",{});
	if(sessionid.substring(0,5) == "Error"){
		if(retries < 1) return sessionid;
		else return await getSessionID_inner(retries - 1);
	}
	else{
		return sessionid;
	}
}
/*
Make a call to the OpenAI API Azure Function that I have set up ahead of time.
*/
async function AIConversation(prompt, useQuestions){
	//console.log("OpenAI Conversation Prompt: " + prompt)
	var params = {"prompt": prompt, "sessionid": sessionid, "LLM": LLM,"UseQuestions":(useQuestions ? "yes" : "no")};
	var response = await AzureFunction("AIConversation",params);
	//console.log("Response: " + response);
	return response;
}

/*
Record the time that the consent is signed. This will also create a new record in the pilot app results table.
*/
async function NewRecord(){
	var params = {"SessionID": sessionid};
	var functionName = "NewRecord"
	await AzureFunction(functionName,params);
}

/*
Make a call to any Azyure function in the tixclarifyingquestions function set.
*/
async function AzureFunction(functionName, params){
	try{
		//console.log("Azure Function Call: " + functionName);
		var URI = "https://tixclarifyingquestions.azurewebsites.net/api/" + functionName + "?"
		var response = await postData(URI, params)
		return response;
	}
	catch(err){
		processingError(err);
	}
}

//Use Fetch to sent a POST request
async function postData(url = "", data = {}) {
  const response = await fetch(url, {
    method: "POST",
    mode: "cors", 
    credentials: "same-origin",
    body: JSON.stringify(data),
  });
  
  const answer = await response.text();
  //console.log(answer);
  return answer; 
}

</script>